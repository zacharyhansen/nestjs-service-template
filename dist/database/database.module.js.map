{"version":3,"sources":["../../src/database/database.module.ts"],"sourcesContent":["import { Global, Module } from '@nestjs/common';\nimport { PostgresDialect } from 'kysely';\nimport { ConfigService } from '@nestjs/config';\nimport { Pool } from 'pg';\n\nimport { Database } from './database';\n\nimport { fetchGCPSecrets } from '~/env/gcp-secrets/fetch-secrets';\n\n@Global()\n@Module({\n  exports: [Database, 'PoolReadOnly'],\n  providers: [\n    {\n      inject: [ConfigService],\n      provide: Database,\n      useFactory: async (configService: ConfigService) => {\n        console.log({ SECRET_SOURCE: configService.get('SECRET_SOURCE') });\n\n        if (\n          configService.get('SECRET_SOURCE') === 'LOCAL' ||\n          !configService.get('SECRET_SOURCE')\n        ) {\n          return new Database({\n            dialect: new PostgresDialect({\n              pool: new Pool({\n                database: process.env.DATABASE_NAME,\n                host: process.env.DATABASE_HOST,\n                password: process.env.DATABASE_PASSWORD,\n                port: Number.parseInt(process.env.DATABASE_PORT!.toString()),\n                user: process.env.DATABASE_USER,\n              }),\n            }),\n          });\n        }\n\n        const secrets = await fetchGCPSecrets();\n\n        return new Database({\n          dialect: new PostgresDialect({\n            pool: new Pool({\n              database: secrets.DATABASE_NAME,\n              host: secrets.DATABASE_HOST,\n              password: secrets.DATABASE_PASSWORD,\n              port: Number.parseInt(secrets.DATABASE_PORT!.toString()),\n              user: secrets.DATABASE_USER,\n            }),\n          }),\n        });\n      },\n    },\n    {\n      inject: [ConfigService],\n      provide: 'PoolReadOnly',\n      useFactory: async (configService: ConfigService) => {\n        console.log({ SECRET_SOURCE: configService.get('SECRET_SOURCE') });\n\n        if (\n          configService.get('SECRET_SOURCE') === 'LOCAL' ||\n          !configService.get('SECRET_SOURCE')\n        ) {\n          return new Pool({\n            database: process.env.DATABASE_NAME,\n            host: process.env.DATABASE_HOST,\n            password: process.env.DATABASE_PASSWORD,\n            port: Number.parseInt(process.env.DATABASE_PORT!.toString()),\n            user: process.env.DATABASE_USER,\n          });\n        }\n\n        const secrets = await fetchGCPSecrets();\n\n        return new Pool({\n          database: secrets.DATABASE_NAME,\n          host: secrets.DATABASE_HOST,\n          password: secrets.DATABASE_PASSWORD,\n          port: Number.parseInt(secrets.DATABASE_PORT!.toString()),\n          user: secrets.DATABASE_USER,\n        });\n      },\n    },\n  ],\n})\nexport class DatabaseModule {}\n"],"names":["Global","Module","PostgresDialect","ConfigService","Pool","Database","fetchGCPSecrets","DatabaseModule","exports","providers","inject","provide","useFactory","configService","console","log","SECRET_SOURCE","get","dialect","pool","database","process","env","DATABASE_NAME","host","DATABASE_HOST","password","DATABASE_PASSWORD","port","Number","parseInt","DATABASE_PORT","toString","user","DATABASE_USER","secrets"],"mappings":";;;;;;AAAA,SAASA,MAAM,EAAEC,MAAM,QAAQ,iBAAiB;AAChD,SAASC,eAAe,QAAQ,SAAS;AACzC,SAASC,aAAa,QAAQ,iBAAiB;AAC/C,SAASC,IAAI,QAAQ,KAAK;AAE1B,SAASC,QAAQ,QAAQ,gBAAa;AAEtC,SAASC,eAAe,QAAQ,sCAAkC;AA4ElE,OAAO,MAAMC;AAAgB;;;;QAxE3BC,SAAS;YAACH;YAAU;SAAe;QACnCI,WAAW;YACT;gBACEC,QAAQ;oBAACP;iBAAc;gBACvBQ,SAASN;gBACTO,YAAY,OAAOC;oBACjBC,QAAQC,GAAG,CAAC;wBAAEC,eAAeH,cAAcI,GAAG,CAAC;oBAAiB;oBAEhE,IACEJ,cAAcI,GAAG,CAAC,qBAAqB,WACvC,CAACJ,cAAcI,GAAG,CAAC,kBACnB;wBACA,OAAO,IAAIZ,SAAS;4BAClBa,SAAS,IAAIhB,gBAAgB;gCAC3BiB,MAAM,IAAIf,KAAK;oCACbgB,UAAUC,QAAQC,GAAG,CAACC,aAAa;oCACnCC,MAAMH,QAAQC,GAAG,CAACG,aAAa;oCAC/BC,UAAUL,QAAQC,GAAG,CAACK,iBAAiB;oCACvCC,MAAMC,OAAOC,QAAQ,CAACT,QAAQC,GAAG,CAACS,aAAa,CAAEC,QAAQ;oCACzDC,MAAMZ,QAAQC,GAAG,CAACY,aAAa;gCACjC;4BACF;wBACF;oBACF;oBAEA,MAAMC,UAAU,MAAM7B;oBAEtB,OAAO,IAAID,SAAS;wBAClBa,SAAS,IAAIhB,gBAAgB;4BAC3BiB,MAAM,IAAIf,KAAK;gCACbgB,UAAUe,QAAQZ,aAAa;gCAC/BC,MAAMW,QAAQV,aAAa;gCAC3BC,UAAUS,QAAQR,iBAAiB;gCACnCC,MAAMC,OAAOC,QAAQ,CAACK,QAAQJ,aAAa,CAAEC,QAAQ;gCACrDC,MAAME,QAAQD,aAAa;4BAC7B;wBACF;oBACF;gBACF;YACF;YACA;gBACExB,QAAQ;oBAACP;iBAAc;gBACvBQ,SAAS;gBACTC,YAAY,OAAOC;oBACjBC,QAAQC,GAAG,CAAC;wBAAEC,eAAeH,cAAcI,GAAG,CAAC;oBAAiB;oBAEhE,IACEJ,cAAcI,GAAG,CAAC,qBAAqB,WACvC,CAACJ,cAAcI,GAAG,CAAC,kBACnB;wBACA,OAAO,IAAIb,KAAK;4BACdgB,UAAUC,QAAQC,GAAG,CAACC,aAAa;4BACnCC,MAAMH,QAAQC,GAAG,CAACG,aAAa;4BAC/BC,UAAUL,QAAQC,GAAG,CAACK,iBAAiB;4BACvCC,MAAMC,OAAOC,QAAQ,CAACT,QAAQC,GAAG,CAACS,aAAa,CAAEC,QAAQ;4BACzDC,MAAMZ,QAAQC,GAAG,CAACY,aAAa;wBACjC;oBACF;oBAEA,MAAMC,UAAU,MAAM7B;oBAEtB,OAAO,IAAIF,KAAK;wBACdgB,UAAUe,QAAQZ,aAAa;wBAC/BC,MAAMW,QAAQV,aAAa;wBAC3BC,UAAUS,QAAQR,iBAAiB;wBACnCC,MAAMC,OAAOC,QAAQ,CAACK,QAAQJ,aAAa,CAAEC,QAAQ;wBACrDC,MAAME,QAAQD,aAAa;oBAC7B;gBACF;YACF;SACD"}